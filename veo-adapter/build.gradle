def generatedSchemasDir = "$buildDir/generated_entity_schemas"

sourceSets {
    main {
        resources {
            srcDir generatedSchemasDir
            exclude 'schemas/custom', 'schemas/links'
        }
    }
}

apply plugin: 'groovy'
apply plugin: 'java-library'

configurations {
    generateSchemas
}

dependencies {

    api project(":veo-core-usecase")

    implementation 'javax.validation:validation-api'

    compileOnly('org.projectlombok:lombok')
    compileOnly 'io.swagger.core.v3:swagger-core'

    testImplementation 'io.swagger.core.v3:swagger-core'
    testImplementation 'org.spockframework:spock-spring'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'com.networknt:json-schema-validator'

    testRuntimeOnly 'com.h2database:h2'

    generateSchemas 'com.github.victools:jsonschema-generator'
    generateSchemas 'com.github.victools:jsonschema-module-jackson'
    generateSchemas 'com.github.victools:jsonschema-module-javax-validation'
    generateSchemas 'com.github.victools:jsonschema-module-swagger-2'
    generateSchemas 'io.swagger.core.v3:swagger-annotations:2.1.5'
}

task generateEntitySchemas(type: JavaExec) {
    def targetDirectory = file("$generatedSchemasDir/schemas")
    def schemaSnippetDir = file("src/main/resources/schemas")
    outputs.dir targetDirectory
    inputs.files compileJava.outputs
    inputs.files schemaSnippetDir
    classpath compileJava.outputs.files
    classpath compileJava.classpath
    classpath configurations.generateSchemas
    classpath file("${rootDir}/buildSrc/build/classes/java/main")
    main = 'org.veo.GenerateEntitySchema'
    args = [
        targetDirectory.absolutePath,
        schemaSnippetDir.absolutePath,
        'org.veo.adapter.presenter.api.dto.full',
        'Asset',
        'Control',
        'Document',
        'Incident',
        'Scenario',
        'Person',
        'Process',
        'Scope'
    ]
}

plugins.withId('eclipse'){
    eclipse {
        synchronizationTasks generateEntitySchemas
        autoBuildTasks generateEntitySchemas
    }
}

processResources.dependsOn(generateEntitySchemas)

task checkTranslations {
    def langFile = file('src/main/resources/lang/lang.json')
    inputs.file langFile
    def customSchemaFiles = fileTree(dir: 'src/main/resources/schemas/custom/', include: '**/*.json')
    inputs.files customSchemaFiles

    doLast {
        def langJson = new groovy.json.JsonSlurper().parse(langFile)
        def languagesToCheck = [
            'German': langJson.lang.de,
            'English': langJson.lang.en
        ]

        def handleTranslationKey = {translationKey, location = null ->
            languagesToCheck.each {lang, json->
                def translation = json.remove(translationKey)
                if (translation == null) {
                    logger.warn("Missing $lang translation for $translationKey in $location")
                }
            }
        }

        // ModelObject base attributes
        handleTranslationKey('name', 'ModelObject base attributes')
        handleTranslationKey('abbreviation', 'ModelObject base attributes')
        handleTranslationKey('description', 'ModelObject base attributes')

        customSchemaFiles.each { file->
            logger.info "Loading $file"
            def data = new groovy.json.JsonSlurper().parse(file)
            def isLinkSchema = data.items != null
            if (isLinkSchema) {
                // relevant data is nested in link schemas
                data = data.items
                // link IDs should be translated, custom aspect IDs should not
                handleTranslationKey(data.properties.type.enum.first(), "$file.name (custom link id)")
            }

            def properties = data.properties.attributes.properties
            def propertyNames = properties.keySet()
            logger.info "property names: $propertyNames"

            // custom aspect attribute ID / field in the editor
            properties.each {key, value->
                handleTranslationKey(key, "$file.name (custom aspect/link attribute id)")
                // custom aspect enum entry / value in drop-down
                value.enum?.each {
                    handleTranslationKey(it, "$file.name (custom aspect/link select value id)")
                }
                // custom aspect enum entry / value in multi-value drop-down
                value.items?.enum?.each {
                    handleTranslationKey(it, "$file.name (custom aspect/link select value id)")
                }
            }
        }
        languagesToCheck.each {lang, json->
            json.each {
                logger.warn("Unused $lang translation $it")
            }
        }
    }
}

check.dependsOn checkTranslations